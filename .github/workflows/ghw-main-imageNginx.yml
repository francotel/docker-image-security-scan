name: nginx-images-pipeline

on:
  workflow_dispatch:
    inputs:
      image:
        description: Imagen a procesar
        type: choice
        required: true
        options:
          - base
          - ingress

      target_env:
        description: Ambiente destino
        type: choice
        required: true
        options:
          - desa
          - test
          - prod

jobs:
  job_vd_checkActor:
    name: üîê Validar Actor
    runs-on: ubuntu-latest
    # permissions:
    #   contents: read          # Required to checkout and read repo files
    #   security-events: write  # Required to upload SARIF files to Security tab

    steps:
      - name: Obtener equipos del actor
        uses: tspascoal/get-user-teams-membership@v3
        id: actorTeams
        with:
          username: ${{ github.actor }}
          team: 'CT-DSO-COEDevSecOps,CT-DSO-ChapterDevSecOps,CT-DSO-ChapterDevSecOpsExternal'
          GITHUB_TOKEN: ${{ secrets.SEC_ORG_ALL_GITHUB_VALIDATEACTOR }}

      - name: Validar pertenencia a equipos
        if: steps.actorTeams.outputs.isTeamMember == 'false'
        run: |
          echo "‚ùå Usuario ${{ github.actor }} no pertenece a los equipos autorizados"
          exit 1

  job_publish_image_desa:
    name: üöÄ Publicar imagen en ACR
    if: inputs.target_env == 'desa'
    needs: job_vd_checkActor
    uses: ./.github/workflows/ghw-template-build-push.yml
    with:
      image: ${{ inputs.image }}
      target_env: ${{ inputs.target_env }}
      acr_name: ${{ vars.VAR_ORG_ALL_ACR_SERVER_NAME_DESA }}
    secrets:
      AZ_CLIENT_ID:       ${{ secrets.SEC_ORG_BF_SERVICE_PRINCIPAL_ID_DESA }}
      AZ_CLIENT_SECRET:   ${{ secrets.SEC_ORG_BF_SERVICE_PRINCIPAL_SECRET_DESA }}
      AZ_TENANT_ID:       ${{ secrets.SEC_ORG_ALL_TENANT_ID }}
      AZ_SUBSCRIPTION_ID: ${{ secrets.SEC_ORG_ALL_SUBSCRIPTION_ID_INTEGRA }}

  # # üöÄ Deploy DESA
  # job_deploy_desa:
  #   name: üöÄ Deploy DESA
  #   needs: job_vd_checkActor
  #   if: ${{ inputs.environment == 'desa' }}
  #   uses: ./.github/workflows/deploy-environment.yml
  #   with:
  #     target_path: 'nginx-apins-gatesmc'
  #     target_runner: 'ghrg-bf-desa-devsecops'
  #     environment: 'desa'
  #     k8s_namespace: 'ns-desa-mc-anv-aplicacionnovasys'
  #     aks_name: ${{ vars.VAR_ORG_ALL_SUBSCRIPTION_INTEGRA_AKSMC_NAME_DESA }}
  #     aks_rg: ${{ vars.VAR_ORG_ALL_SUBSCRIPTION_INTEGRA_RG_NAME_DESA }}
  #   secrets:
  #     tenant_id: ${{ secrets.SEC_ORG_ALL_TENANT_ID }}
  #     subscription_id: ${{ vars.VAR_ORG_ALL_SUBSCRIPTION_INTEGRATION_ID }}
  #     sp_id: ${{ secrets.SEC_ORG_BF_SERVICE_PRINCIPAL_ID_DESA }}
  #     sp_secret: ${{ secrets.SEC_ORG_BF_SERVICE_PRINCIPAL_SECRET_DESA }}

  # job_deploy_test:
  #   name: üöÄ Deploy DESA
  #   if: ${{ inputs.environment == 'test' }}
  #   needs: job_vd_checkActor
  #   uses: ./.github/workflows/deploy-environment.yml
  #   with:
  #     target_path: 'nginx-apins-gatesmc'
  #     target_runner: 'ghrg-bf-test-devsecops'
  #     environment: 'test'
  #     k8s_namespace: 'ns-test-mc-anv-aplicacionnovasys'
  #     aks_name: ${{ vars.VAR_ORG_ALL_SUBSCRIPTION_INTEGRA_AKSMC_NAME_TEST }}
  #     aks_rg: ${{ vars.VAR_ORG_ALL_SUBSCRIPTION_INTEGRA_RG_NAME_TEST }}
  #   secrets:
  #     tenant_id: ${{ secrets.SEC_ORG_ALL_TENANT_ID }}
  #     subscription_id: ${{ vars.VAR_ORG_ALL_SUBSCRIPTION_INTEGRATION_ID }}
  #     sp_id: ${{ secrets.SEC_ORG_BF_SERVICE_PRINCIPAL_ID_TEST }}
  #     sp_secret: ${{ secrets.SEC_ORG_BF_SERVICE_PRINCIPAL_SECRET_TEST }}

  # job_deploy_prod:
  #   name: üöÄ Deploy PROD
  #   if: ${{ inputs.environment == 'prod' && needs.Validation.outputs.is_authorized == 'true' }}
  #   needs: job_vd_checkActor
  #   uses: ./.github/workflows/deploy-environment.yml
  #   with:
  #     target_path: 'nginx-apins-gatesmc'
  #     target_runner: 'ghrg-bf-prod-devsecops'
  #     environment: 'prod'
  #     k8s_namespace: 'ns-prod-mc-anv-aplicacionnovasys'
  #     aks_name: ${{ vars.VAR_ORG_ALL_SUBSCRIPTION_INTEGRA_AKSMC_NAME_PROD }}
  #     aks_rg: ${{ vars.VAR_ORG_ALL_SUBSCRIPTION_INTEGRA_RG_NAME_PROD }}
  #   secrets:
  #     tenant_id: ${{ secrets.SEC_ORG_ALL_TENANT_ID }}
  #     subscription_id: ${{ vars.VAR_ORG_ALL_SUBSCRIPTION_INTEGRATION_ID }}
  #     sp_id: ${{ secrets.SEC_ORG_BF_SERVICE_PRINCIPAL_ID_PROD }}
  #     sp_secret: ${{ secrets.SEC_ORG_BF_SERVICE_PRINCIPAL_SECRET_PROD }}

# jobs:
#   job_vd_checkActor:
#     runs-on: ubuntu-latest
#     outputs:
#       teams: ${{ steps.actorTeams.outputs.teams }}
#     steps:
#       - name: stp-getTeamsfromActor
#         uses: tspascoal/get-user-teams-membership@v2
#         id: actorTeams
#         with:
#           username: ${{ github.actor }}
#           GITHUB_TOKEN: ${{ secrets.SEC_ORG_ALL_GITHUB_VALIDATEACTOR }}


#   job_ci_buildImageBaseNode:
#     runs-on: [self-hosted, ghrg-bf-desa-devsecops]
#     if: github.ref == 'refs/heads/desa' &&  (contains(needs.job_vd_checkActor.outputs.teams, 'CT-DSO-COEDevSecOps') || contains(needs.job_vd_checkActor.outputs.teams, 'CT-DSO-ChapterDevSecOps') || contains(needs.job_vd_checkActor.outputs.teams, 'CT-DSO-ChapterDevSecOpsExternal'))
#     needs: job_vd_checkActor
#     environment: env-all-config
#     steps:
#       - name: stp-cloneRepo
#         uses: actions/checkout@v2
#         with:
#           fetch-depth: 1

#       - name: stp-BuildImageBase
#         run: |
#           cd ${{ vars.VAR_REPO_COR_PRINCIPAL_PATH }}/${{ vars.VAR_REPO_COR_BUILD_IMAGE_PATH }}
#           docker build -f ${{ vars.VAR_REPO_COR_DOCKERFILE_NAME }} --no-cache -t ${{ vars.VAR_ORG_ALL_NAME_IMAGE_BASE_NODE_DESA }}:${{ github.run_number }} . 
#           docker tag ${{ vars.VAR_ORG_ALL_NAME_IMAGE_BASE_NODE_DESA }}:${{ github.run_number }} ${{ vars.VAR_ORG_ALL_ACR_SERVER_NAME_DESA }}/${{ vars.VAR_ORG_ALL_NAME_IMAGE_BASE_NODE_DESA }}:${{ github.run_number }}
#           docker tag ${{ vars.VAR_ORG_ALL_NAME_IMAGE_BASE_NODE_DESA }}:${{ github.run_number }} ${{ vars.VAR_ORG_ALL_ACR_SERVER_NAME_DESA }}/${{ vars.VAR_ORG_ALL_NAME_IMAGE_BASE_NODE_DESA }}:${{ vars.VAR_ORG_ALL_BUILD_TAG_LATEST }}

#       - name: stp-compressDirectory
#         run: |
#           cd ${{ github.workspace }}
#           tar -czvf ${{ vars.VAR_REPO_COR_ARTIFACT_NAME }}.tar.gz ${{ vars.VAR_REPO_COR_PRINCIPAL_PATH }}

#       - name: stp-uploadDirCompressed
#         uses: actions/upload-artifact@v4
#         with:
#           name: ${{ vars.VAR_REPO_COR_ARTIFACT_NAME }}.tar.gz
#           path: ${{ github.workspace }}/${{ vars.VAR_REPO_COR_PRINCIPAL_PATH }}

#   job_cd_deployImageBaseNode:
#     needs: job_ci_buildImageBaseNode
#     runs-on: [self-hosted, ghrg-bf-desa-devsecops]
#     environment: env-all-config

#     steps:
#       - name: stp-downloadDirCompressed
#         uses: actions/download-artifact@v4
#         with:
#           name: ${{ vars.VAR_REPO_COR_ARTIFACT_NAME }}.tar.gz
#           path: ${{ github.workspace }}

#       - name: stp-decompressDir
#         run: |
#           cd ${{ github.workspace }}
#           tar -xzvf ${{ vars.VAR_REPO_COR_ARTIFACT_NAME }}.tar.gz -C ${{ github.workspace }}
          
#       - name: stp-AzLogin
#         run: |
#           az login --service-principal -u ${{ secrets.SEC_ORG_BF_SERVICE_PRINCIPAL_ID_DESA }} -p ${{ secrets.SEC_ORG_BF_SERVICE_PRINCIPAL_SECRET_DESA }} --tenant ${{ secrets.SEC_ORG_ALL_TENANT_ID }}

#       - name: stp-DeployImageBase
#         run: |
#           az acr login --name ${{ vars.VAR_ORG_ALL_ACR_SERVER_NAME_DESA }}
#           docker push ${{ vars.VAR_ORG_ALL_ACR_SERVER_NAME_DESA }}/${{ vars.VAR_ORG_ALL_NAME_IMAGE_BASE_NODE_DESA }}:${{ github.run_number }}
#           docker push ${{ vars.VAR_ORG_ALL_ACR_SERVER_NAME_DESA }}/${{ vars.VAR_ORG_ALL_NAME_IMAGE_BASE_NODE_DESA }}:${{ vars.VAR_ORG_ALL_BUILD_TAG_LATEST }}
#           docker rmi ${{ vars.VAR_ORG_ALL_NAME_IMAGE_BASE_NODE_DESA }}:${{ github.run_number }}
#           docker rmi ${{ vars.VAR_ORG_ALL_ACR_SERVER_NAME_DESA }}/${{ vars.VAR_ORG_ALL_NAME_IMAGE_BASE_NODE_DESA }}:${{ github.run_number }}
#           docker rmi ${{ vars.VAR_ORG_ALL_ACR_SERVER_NAME_DESA }}/${{ vars.VAR_ORG_ALL_NAME_IMAGE_BASE_NODE_DESA }}:${{ vars.VAR_ORG_ALL_BUILD_TAG_LATEST }}

#   job_cu_repository:
#     runs-on: [self-hosted, ghrg-in-desa-devsecops]
#     needs: [job_ci_buildImageBaseNode, job_cd_deployImageBaseNode]
#     if: always()
#     steps:
#       - name: stp-cleanupArtifacts
#         if: always()
#         run: |
#           cd ${{ github.workspace }}
#           ls -lta
#           echo "Eliminando archivos temporales..."
#           rm -rf .[^.]* *
#           ls -lta
#           echo "Cleanup completado."