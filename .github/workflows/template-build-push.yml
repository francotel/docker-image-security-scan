name: secure-docker-pipeline-template

on:
  workflow_call:
    inputs:
      # Application configuration
      image:
        type: string
        required: true
      
      dockerfile_path:
        type: string
        required: true
        description: "Path to the Dockerfile"
      
      target_env:
        type: string
        required: true
        description: "Target environment (dev, stg, prd)"
    
    secrets:
      # AWS credentials
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      AWS_REGION:
        required: true
      AWS_ECR_URL:
        required: true

env:
  # Security scanning configuration
  FAIL_ON_CRITICAL: true
  FAIL_ON_HIGH: true

jobs:
  build_scan_and_push:
    name: ðŸ›¡ï¸ Build, Scan & Push
    runs-on: ubuntu-latest
    environment: ${{ inputs.target_env }}

    steps:
      # ============ INITIAL SETUP ============
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”‘ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ðŸ” Login to AWS ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ============ IMAGE TAGGING ============
      - name: ðŸ·ï¸ Generate image tags
        id: generate-tags
        run: |
          SHORT_SHA=${GITHUB_SHA::8}
          echo "IMAGE_TAG_SHA=sha-${SHORT_SHA}" >> $GITHUB_ENV
          echo "IMAGE_TAG_ENV=${{ inputs.target_env }}-latest" >> $GITHUB_ENV

      # ============ LOCAL BUILD FOR SCANNING ============
      - name: ðŸ³ Build image locally (for scanning)
        id: build-local
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ inputs.dockerfile_path }}
          push: false
          no-cache: true
          tags: |
            local-scan:${{ env.IMAGE_TAG_SHA }}
          labels: |
            com.github.repository=${{ github.repository }}
            com.github.commit=${{ github.sha }}
            com.scan.purpose=security-validation

      # ============ VULNERABILITY SCANNING ============
      - name: ðŸ” Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        id: trivy-scan
        with:
          image-ref: local-scan:${{ env.IMAGE_TAG_SHA }}
          format: 'json'
          output: 'trivy-results.json'
          trivy-config: './config/trivy/trivy.yaml' 
          ignore-unfixed: false
          timeout: '300s'

      - name: ðŸ“Š Generate vulnerability report
        run: |
          echo "## ðŸ” Trivy Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f trivy-results.json ]; then
            TOTAL=$(jq '[.Results[] | (.Vulnerabilities // []), (.Misconfigurations // []), (.Secrets // [])] | flatten | length' trivy-results.json || echo 0)
            CRIT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json || echo 0)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json || echo 0)
            MED=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-results.json || echo 0)
            LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-results.json || echo 0)
            MIS=$(jq '[.Results[]?.Misconfigurations[]?] | length' trivy-results.json || echo 0)
            SECRETS=$(jq '[.Results[]?.Secrets[]?] | length' trivy-results.json || echo 0)

            echo "### ðŸ“ˆ Security Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
            [ "$CRIT" -gt 0 ] && echo "| Vulnerabilities | ðŸ”´ CRITICAL | $CRIT |" >> $GITHUB_STEP_SUMMARY
            [ "$HIGH" -gt 0 ] && echo "| Vulnerabilities | ðŸŸ  HIGH | $HIGH |" >> $GITHUB_STEP_SUMMARY
            [ "$MED" -gt 0 ] && echo "| Vulnerabilities | ðŸŸ¡ MEDIUM | $MED |" >> $GITHUB_STEP_SUMMARY
            [ "$LOW" -gt 0 ] && echo "| Vulnerabilities | ðŸ”µ LOW | $LOW |" >> $GITHUB_STEP_SUMMARY
            [ "$MIS" -gt 0 ] && echo "| MISCONFIGURATIONS | - | $MIS |" >> $GITHUB_STEP_SUMMARY
            [ "$SECRETS" -gt 0 ] && echo "| Secrets | - | $SECRETS |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total** | - | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### ðŸ“‹ Scan Information" >> $GITHUB_STEP_SUMMARY
            echo "- **Scan Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
            echo "- **Source Branch:** ${{ github.head_ref || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY

            if [ "$TOTAL" -eq 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **No security vulnerabilities detected.**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ **No Trivy results found**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: List Vulnerabilities
        run: |
          echo "### ðŸ” Vulnerability Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f trivy-results.json ]; then
            # CRITICAL Vulnerabilities
            CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json || echo 0)
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "#### ðŸ”´ Critical Vulnerabilities ($CRITICAL_COUNT)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| CVE | Package | Version | Fixed Version |" >> $GITHUB_STEP_SUMMARY
              echo "|-----|---------|---------|---------------|" >> $GITHUB_STEP_SUMMARY
              jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL") | "| \(.VulnerabilityID) | `\(.PkgName)` | `\(.InstalledVersion)` | `\(.FixedVersion // "Not available")` |"' trivy-results.json 2>/dev/null | head -15 >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # HIGH Vulnerabilities
            HIGH_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json || echo 0)
            if [ "$HIGH_COUNT" -gt 0 ]; then
              echo "#### ðŸŸ  High Vulnerabilities ($HIGH_COUNT)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| CVE | Package | Version | Fixed Version |" >> $GITHUB_STEP_SUMMARY
              echo "|-----|---------|---------|---------------|" >> $GITHUB_STEP_SUMMARY
              jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH") | "| \(.VulnerabilityID) | `\(.PkgName)` | `\(.InstalledVersion)` | `\(.FixedVersion // "Not available")` |"' trivy-results.json 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$CRITICAL_COUNT" -eq 0 ] && [ "$HIGH_COUNT" -eq 0 ]; then
              echo "âœ… No critical or high vulnerabilities found." >> $GITHUB_STEP_SUMMARY
            fi
            
            # Additional statistics
            echo "#### ðŸ“ˆ Statistics" >> $GITHUB_STEP_SUMMARY
            echo "- **Total CVEs:** $(jq '[.Results[]?.Vulnerabilities[]? | .VulnerabilityID] | length' trivy-results.json 2>/dev/null || echo 0)" >> $GITHUB_STEP_SUMMARY
            echo "- **Affected packages:** $(jq '.Results[]?.Vulnerabilities[]? | .PkgName' trivy-results.json 2>/dev/null | sort -u | wc -l)" >> $GITHUB_STEP_SUMMARY
            echo "- **Fixes available:** $(jq '[.Results[]?.Vulnerabilities[]? | select(.FixedVersion != null)] | length' trivy-results.json 2>/dev/null || echo 0)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Results file not found" >> $GITHUB_STEP_SUMMARY
          fi

      # ============ CONFIGURATION SCANNING ============
      - name: ðŸ—ï¸ Run Checkov configuration scan
        uses: bridgecrewio/checkov-action@v12
        id: checkov-scan
        with:
          directory: .
          dockerfile_path: ${{ inputs.dockerfile_path }}
          framework: dockerfile
          config_file: ./config/checkov/checkov.yaml
          output_format: github_failed_only
          output_file_path: .

      - name: ðŸ“‹ Generate configuration report
        run: |
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ—ï¸ Checkov Configuration Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f results_github_failed_only.md ]; then
            if grep -q "Failed" results_github_failed_only.md; then
              cat results_github_failed_only.md >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No critical or high vulnerabilities found." >> $GITHUB_STEP_SUMMARY
            fi
          fi

      # ============ SECURITY VALIDATION ============
      - name: âš–ï¸ Validate security results
        id: security-validation
        run: |
          echo "ðŸ”’ Security Validation Check"
          echo "============================"
          
          URL_SUMMARY="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#summary"
          
          # Count Trivy issues
          TRIVY_ISSUES=0
          if [ -f trivy-results.json ]; then
            TRIVY_ISSUES=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | length' trivy-results.json 2>/dev/null || echo 0)
          fi

          # Count Checkov issues
          CHECKOV_ISSUES=0
          if [ -f results_github_failed_only.md ]; then
            FAILED=$(grep -o "Failed Checks: [0-9]*" results_github_failed_only.md | head -1 | grep -o "[0-9]*" || echo 0)
            CHECKOV_ISSUES=$FAILED
          fi
          
          TOTAL_ISSUES=$((TRIVY_ISSUES + CHECKOV_ISSUES))
          echo $TOTAL_ISSUES
          
          if [ "$TOTAL_ISSUES" -gt 0 ]; then
            echo ""
            echo "âŒ **WORKFLOW FAILED**"
            echo ""
            echo "**Issues detected:**"
            echo ""
            [ "$TRIVY_ISSUES" -gt 0 ] && echo "- ðŸ³ **Trivy:** $TRIVY_ISSUES critical/high vulnerabilities"
            [ "$CHECKOV_ISSUES" -gt 0 ] && echo "- ðŸ—ï¸ **Checkov:** $CHECKOV_ISSUES failed checks"
            echo ""
            echo "**Required actions:**"
            echo "1. ðŸ“‹ Review the full report: $URL_SUMMARY"
            echo "2. ðŸ”§ Fix the identified issues"
            echo "3. ðŸ”„ Run the workflow again"
            echo ""
            echo "ðŸ”— Direct link to Summary:"
            echo "$URL_SUMMARY"
            exit 1
          fi
          
          echo ""
          echo "âœ… **ALL VALIDATIONS PASSED**"
          echo "ðŸš€ Workflow approved - can continue"
          echo "ðŸš€ Proceeding with image publication..."

      # ============ PUSH TO AWS ECR ============
      - name: ðŸš€ Build and push to AWS ECR
        if: success() && steps.security-validation.outcome == 'success'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ inputs.dockerfile_path }}
          push: false
          no-cache: true
          tags: |
            ${{ secrets.AWS_ECR_URL }}/${{ inputs.image }}:${{ env.IMAGE_TAG_SHA }}
            ${{ secrets.AWS_ECR_URL }}/${{ inputs.image }}:${{ env.IMAGE_TAG_ENV }}
          labels: |
            com.github.repository=${{ github.repository }}
            com.github.commit=${{ github.sha }}
            com.github.workflow=${{ github.workflow }}
            com.build.timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            com.environment=${{ inputs.target_env }}
            com.aws.region=${{ secrets.AWS_REGION }}

      # ============ CLEANUP ============
      - name: ðŸ§¹ Cleanup temporary resources
        if: always()
        run: |
          echo "ðŸ§¼ Cleaning up temporary files..."
          
          # Remove scan files
          rm -f trivy-results.json 2>/dev/null || true
          rm -f results_github_failed_only.md 2>/dev/null || true
          
          # Remove local images
          docker rmi -f local-scan:${{ env.COMMIT_TAG }} 2>/dev/null || true
          docker rmi -f ${{ env.ECR_IMAGE_NAME }}:${{ env.IMAGE_TAG_SHA }}
          docker rmi -f ${{ env.ECR_IMAGE_NAME }}:${{ env.IMAGE_TAG_ENV }}
          
          echo "âœ… Cleanup completed"