name: secure-docker-pipeline-template

on:
  workflow_call:
    inputs:
      # Application configuration
      image:
        type: string
        required: true
      
      dockerfile_path:
        type: string
        required: true
        description: "Path to the Dockerfile"
      
      target_env:
        type: string
        required: true
        description: "Target environment (dev, stg, prd)"
      
      aws_ecr_registry:
        type: string
        required: true
        description: "AWS ECR registry URL"
    
    secrets:
      # AWS credentials
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      AWS_REGION:
        required: true

env:
  # Security scanning configuration
  TRIVY_VERSION: "0.51.1"
  CHECKOV_VERSION: "3.2.497"
  SCAN_TIMEOUT_MINUTES: 10
  FAIL_ON_CRITICAL: true
  FAIL_ON_HIGH: true

jobs:
  build_scan_and_push:
    name: üõ°Ô∏è Build, Scan & Push
    runs-on: ubuntu-latest
    environment: ${{ inputs.target_env }}

    steps:
      # ============ INITIAL SETUP ============
      - name: üìÇ Checkout repository
        uses: actions/checkout@v4

      - name: üîë Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: üîê Login to AWS ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ============ IMAGE TAGGING ============
      - name: üè∑Ô∏è Generate image tags
        id: generate-tags
        run: |
          SHORT_SHA=${GITHUB_SHA::8}
          echo "IMAGE_TAG_SHA=sha-${SHORT_SHA}" >> $GITHUB_ENV
          echo "IMAGE_TAG_ENV=${{ inputs.target_env }}-latest" >> $GITHUB_ENV

      # ============ LOCAL BUILD FOR SCANNING ============
      - name: üê≥ Build image locally (for scanning)
        id: build-local
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ inputs.dockerfile_path }}
          push: false
          no-cache: true
          tags: |
            local-scan:${{ env.IMAGE_TAG_SHA }}
          labels: |
            com.github.repository=${{ github.repository }}
            com.github.commit=${{ github.sha }}
            com.scan.purpose=security-validation

      # # ============ VULNERABILITY SCANNING ============
      # - name: üîç Run Trivy vulnerability scan
      #   uses: aquasecurity/trivy-action@master
      #   id: trivy-scan
      #   with:
      #     image-ref: local-scan:${{ env.IMAGE_TAG_SHA }}
      #     format: 'json'
      #     output: 'trivy-results.json'
      #     trivy-config: './config/trivy/trivy.yaml' 
      #     ignore-unfixed: false
      #     timeout: '300s'

      # - name: üìä Generate vulnerability report
      #   run: |
      #     echo "## üîç Trivy Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
      #     echo "" >> $GITHUB_STEP_SUMMARY

      #     if [ -f trivy-results.json ]; then
      #       TOTAL=$(jq '[.Results[] | (.Vulnerabilities // []), (.Misconfigurations // []), (.Secrets // [])] | flatten | length' trivy-results.json || echo 0)
      #       CRIT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json || echo 0)
      #       HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json || echo 0)
      #       MED=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-results.json || echo 0)
      #       LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-results.json || echo 0)
      #       MIS=$(jq '[.Results[]?.Misconfigurations[]?] | length' trivy-results.json || echo 0)
      #       SECRETS=$(jq '[.Results[]?.Secrets[]?] | length' trivy-results.json || echo 0)

      #       echo "### üìà Security Summary" >> $GITHUB_STEP_SUMMARY
      #       echo "" >> $GITHUB_STEP_SUMMARY
      #       echo "| Severity | Count | Status |" >> $GITHUB_STEP_SUMMARY
      #       echo "|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
      #       [ "$CRIT" -gt 0 ] && echo "| Vulnerabilities | üî¥ CRITICAL | $CRIT |" >> $GITHUB_STEP_SUMMARY
      #       [ "$HIGH" -gt 0 ] && echo "| Vulnerabilities | üü† HIGH | $HIGH |" >> $GITHUB_STEP_SUMMARY
      #       [ "$MED" -gt 0 ] && echo "| Vulnerabilities | üü° MEDIUM | $MED |" >> $GITHUB_STEP_SUMMARY
      #       [ "$LOW" -gt 0 ] && echo "| Vulnerabilities | üîµ LOW | $LOW |" >> $GITHUB_STEP_SUMMARY
      #       [ "$MIS" -gt 0 ] && echo "| MISCONFIGURATIONS | - | $MIS |" >> $GITHUB_STEP_SUMMARY
      #       [ "$SECRETS" -gt 0 ] && echo "| Secrets | - | $SECRETS |" >> $GITHUB_STEP_SUMMARY
      #       echo "| **Total** | - | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
      #       echo "" >> $GITHUB_STEP_SUMMARY

      #       echo "### üìã Scan Information" >> $GITHUB_STEP_SUMMARY
      #       echo "- **Scan Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
      #       echo "- **Source Branch:** ${{ github.head_ref || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
      #       echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY

      #       if [ "$TOTAL" -eq 0 ]; then
      #         echo "" >> $GITHUB_STEP_SUMMARY
      #         echo "‚úÖ **No security vulnerabilities detected.**" >> $GITHUB_STEP_SUMMARY
      #       fi
      #     else
      #       echo "‚ö†Ô∏è **No Trivy results found**" >> $GITHUB_STEP_SUMMARY
      #     fi

      # - name: List Vulnerabilities
      #   run: |
      #     echo "### üîç Vulnerability Details" >> $GITHUB_STEP_SUMMARY
      #     echo "" >> $GITHUB_STEP_SUMMARY
          
      #     if [ -f trivy-results.json ]; then
      #       # CRITICAL Vulnerabilities
      #       CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json || echo 0)
      #       if [ "$CRITICAL_COUNT" -gt 0 ]; then
      #         echo "#### üî¥ Critical Vulnerabilities ($CRITICAL_COUNT)" >> $GITHUB_STEP_SUMMARY
      #         echo "" >> $GITHUB_STEP_SUMMARY
      #         echo "| CVE | Package | Version | Fixed Version |" >> $GITHUB_STEP_SUMMARY
      #         echo "|-----|---------|---------|---------------|" >> $GITHUB_STEP_SUMMARY
      #         jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL") | "| \(.VulnerabilityID) | `\(.PkgName)` | `\(.InstalledVersion)` | `\(.FixedVersion // "Not available")` |"' trivy-results.json 2>/dev/null | head -15 >> $GITHUB_STEP_SUMMARY
      #         echo "" >> $GITHUB_STEP_SUMMARY
      #       fi
            
      #       # HIGH Vulnerabilities
      #       HIGH_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json || echo 0)
      #       if [ "$HIGH_COUNT" -gt 0 ]; then
      #         echo "#### üü† High Vulnerabilities ($HIGH_COUNT)" >> $GITHUB_STEP_SUMMARY
      #         echo "" >> $GITHUB_STEP_SUMMARY
      #         echo "| CVE | Package | Version | Fixed Version |" >> $GITHUB_STEP_SUMMARY
      #         echo "|-----|---------|---------|---------------|" >> $GITHUB_STEP_SUMMARY
      #         jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH") | "| \(.VulnerabilityID) | `\(.PkgName)` | `\(.InstalledVersion)` | `\(.FixedVersion // "Not available")` |"' trivy-results.json 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY
      #         echo "" >> $GITHUB_STEP_SUMMARY
      #       fi
            
      #       if [ "$CRITICAL_COUNT" -eq 0 ] && [ "$HIGH_COUNT" -eq 0 ]; then
      #         echo "‚úÖ No critical or high vulnerabilities found." >> $GITHUB_STEP_SUMMARY
      #       fi
            
      #       # Additional statistics
      #       echo "#### üìà Statistics" >> $GITHUB_STEP_SUMMARY
      #       echo "- **Total CVEs:** $(jq '[.Results[]?.Vulnerabilities[]? | .VulnerabilityID] | length' trivy-results.json 2>/dev/null || echo 0)" >> $GITHUB_STEP_SUMMARY
      #       echo "- **Affected packages:** $(jq '.Results[]?.Vulnerabilities[]? | .PkgName' trivy-results.json 2>/dev/null | sort -u | wc -l)" >> $GITHUB_STEP_SUMMARY
      #       echo "- **Fixes available:** $(jq '[.Results[]?.Vulnerabilities[]? | select(.FixedVersion != null)] | length' trivy-results.json 2>/dev/null || echo 0)" >> $GITHUB_STEP_SUMMARY
      #     else
      #       echo "‚ö†Ô∏è Results file not found" >> $GITHUB_STEP_SUMMARY
      #     fi

      # ============ CONFIGURATION SCANNING ============
      - name: üèóÔ∏è Run Checkov configuration scan
        uses: bridgecrewio/checkov-action@v12
        id: checkov-scan
        with:
          directory: .
          dockerfile_path: ${{ inputs.dockerfile_path }}
          framework: dockerfile
          config_file: /config/checkov/checkov.yaml
          output_format: github_failed_only
          #output_file_path: .

      # # ============ ESCANEO DE SEGURIDAD - CHECKOV ============
      # - name: stp-CheckovScan
      #   run: |
      #     echo "üîé Escaneando Dockerfile con Checkov..."

  
      #       --output-file /src/checkov-report

      # - name: stp-CheckovReportSummary
      #   id: checkov-report
      #   run: |
      #     echo "---" >> $GITHUB_STEP_SUMMARY
      #     echo "## üèóÔ∏è Reporte de Escaneo - Checkov" >> $GITHUB_STEP_SUMMARY
      #     echo "" >> $GITHUB_STEP_SUMMARY
          
      #     if [ -f checkov-report/results_github_failed_only.md ]; then
      #       if grep -q "Failed" checkov-report/results_github_failed_only.md; then
      #         cat checkov-report/results_github_failed_only.md >> $GITHUB_STEP_SUMMARY
      #       else
      #         echo "‚úÖ Sin problemas detectados" >> $GITHUB_STEP_SUMMARY
      #       fi
      #     fi

      # # ============ LIMPIEZA DE RECURSOS ============
      # - name: stp-CleanResources
      #   if: always()
      #   run: |
      #     echo "üßπ Limpiando archivos temporales..."
      #     sudo rm -rf "${{ github.workspace }}/checkov-report" 2>/dev/null || true
      #     sudo rm -rf "${{ github.workspace }}/trivy-report" 2>/dev/null || true

      # - name: stp-CleanUpImages
      #   working-directory: ./docker/${{ inputs.image }}
      #   run: |
      #     echo "üóëÔ∏è Eliminando im√°genes locales..."
      #     docker rmi -f ${{ inputs.acr_name }}.azurecr.io/nginx-${{ inputs.image }}:${{ env.IMAGE_TAG_SHA }} 2>/dev/null || echo "‚ö†Ô∏è No se pudo eliminar la imagen sha"
      #     docker rmi -f ${{ inputs.acr_name }}.azurecr.io/nginx-${{ inputs.image }}:${{ env.IMAGE_TAG_ENV }} 2>/dev/null || echo "‚ö†Ô∏è No se pudo eliminar la imagen latest"

      # # ============ VALIDACI√ìN FINAL ============
      # - name: stp-BlockSummaryFailures
      #   run: |
      #     echo "üîí Validaci√≥n Final de Seguridad"
      #     echo "================================"
          
      #     URL_SUMMARY="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#summary"
          
      #     # Contar problemas de Trivy
      #     PROBLEMAS_TRIVY=0
      #     if [ -f trivy-report/trivy-results.json ]; then
      #       PROBLEMAS_TRIVY=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | length' ./trivy-report/trivy-results.json 2>/dev/null || echo 0)
      #     fi
          
      #     # Contar problemas de Checkov
      #     PROBLEMAS_CHECKOV=0
      #     if [ -f checkov-report/results_github_failed_only.md ]; then
      #       FALLIDOS=$(grep -o "Failed Checks: [0-9]*" checkov-report/results_github_failed_only.md | head -1 | grep -o "[0-9]*" || echo 0)
      #       PROBLEMAS_CHECKOV=$FALLIDOS
      #     fi
          
      #     TOTAL_PROBLEMAS=$((PROBLEMAS_TRIVY + PROBLEMAS_CHECKOV))
          
      #     if [ "$TOTAL_PROBLEMAS" -gt 0 ]; then
      #       echo ""
      #       echo "‚ùå **WORKFLOW FALLIDO**"
      #       echo ""
      #       echo "**Problemas detectados:**"
      #       echo ""
      #       [ "$PROBLEMAS_TRIVY" -gt 0 ] && echo "- üê≥ **Trivy:** $PROBLEMAS_TRIVY vulnerabilidades cr√≠ticas/altas"
      #       [ "$PROBLEMAS_CHECKOV" -gt 0 ] && echo "- üèóÔ∏è **Checkov:** $PROBLEMAS_CHECKOV checks fallidos"
      #       echo ""
      #       echo "**Acciones requeridas:**"
      #       echo "1. üìã Revisa el reporte completo: $URL_SUMMARY"
      #       echo "2. üîß Corrige los problemas identificados"
      #       echo "3. üîÑ Vuelve a ejecutar el workflow"
      #       echo ""
      #       echo "üîó Enlace directo al Summary:"
      #       echo "$URL_SUMMARY"
      #       exit 1
      #     fi
          
      #     echo ""
      #     echo "‚úÖ **TODAS LAS VALIDACIONES PASARON**"
      #     echo "üöÄ Workflow aprobado - puede continuar"
      #     echo "üöÄ Procediendo con la publicaci√≥n de la imagen..."

      # # ============ PUBLICACION DE IMAGEN ============
      # - name: stp-PublishDockerImage
      #   if: success()
      #   uses: docker/build-push-action@v5
      #   with:
      #     file: docker/${{ inputs.image }}/Dockerfile
      #     push: false
      #     no-cache: true
      #     tags: |
      #       ${{ inputs.acr_name }}.azurecr.io/nginx-${{ inputs.image }}:${{ env.IMAGE_TAG_SHA }}
      #       ${{ inputs.acr_name }}.azurecr.io/nginx-${{ inputs.image }}:${{ env.IMAGE_TAG_ENV }}
      #     labels: |
      #       org.opencontainers.image.source=https://github.com/${{ github.repository }}
      #       org.opencontainers.image.revision=${{ github.sha }}
      #       org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
      #       org.opencontainers.image.version=${{ env.IMAGE_TAG_ENV }}